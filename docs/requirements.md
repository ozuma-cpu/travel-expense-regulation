# 出張報告書自動生成ツール - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
管理者が設定した旅費規定に基づき、社員が出張情報を入力すると報告書と手当が自動計算され、個人別Googleスプレッドシートに連携。過去データもCSV一括入力で取り込める汎用出張管理ツール。

### 1.2 成功指標

#### 定量的指標
- **報告書作成時間**: 従来30分 → 3分以内に短縮
- **計算ミス発生率**: 手当計算のエラーを0件に
- **規定設定時間**: 会社独自の旅費規定を10分以内で設定完了
- **スプレッドシート同期**: 出張登録後、5秒以内に自動反映
- **過去データ取り込み**: CSV一括インポートで100件を1分以内に処理

#### 定性的指標
- **誰でも簡単**: ITに不慣れな社員でも迷わず入力・閲覧できる
- **柔軟性**: どんな会社の旅費規定にも対応できる汎用性
- **データ活用**: 個人別スプレッドシートで自由に分析・加工できる利便性
- **移行しやすさ**: 既存の過去データをスムーズに取り込める

---

## 2. システム全体像

### 2.1 主要機能一覧
- **出張管理機能**: 出張の登録・一覧・編集・削除・検索・PDF出力
- **CSV一括インポート機能**: 過去の出張データを一括取り込み
- **旅費規定設定機能**: 会社独自の旅費規定（日当、宿泊費、交通費等）を柔軟に設定
- **自動手当計算機能**: 設定した旅費規定に基づいて自動で手当額を計算
- **PDF報告書生成機能**: 出張報告書をPDF形式で出力
- **Google Sheets連携機能**: 個人別スプレッドシートへの自動データ同期

### 2.2 ユーザーロールと権限

**個人利用ツールのため、ロール分けなし**

- **ユーザー（本人）**: 全機能にアクセス可能
  - 出張の登録・編集・削除
  - 出張履歴の閲覧
  - PDF報告書の出力
  - CSV一括インポート
  - 旅費規定の設定・変更
  - Google Sheets連携設定

### 2.3 認証・認可要件

- **認証方式**: Google OAuth 2.0
- **セキュリティレベル**: 個人情報レベル（出張先、日程、目的などの個人業務情報）
- **管理機能**: 全機能を本人が管理（承認フローなし）

**認証フロー**:
1. ユーザーがログインボタンをクリック
2. Googleアカウント選択画面へリダイレクト
3. Google OAuth認証完了
4. アプリケーションへリダイレクト（ログイン完了）

---

## 3. ページ詳細仕様

### 3.1 P-001: ログイン

#### 目的
Googleアカウントで認証し、セキュアな出張データ管理の基盤を提供

#### 主要機能
- Google OAuth 2.0によるログイン
- 初回ログイン時のユーザー情報登録

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 認証 | Googleアカウントでログイン | なし（Googleが処理） | 認証トークン、ユーザー情報 |
| 登録 | 初回ログイン時のユーザー作成 | Googleから取得したユーザー情報 | ユーザーレコード作成完了 |

#### 処理フロー
1. ユーザーが「Googleでログイン」ボタンをクリック
2. Google OAuth認証画面へリダイレクト
3. ユーザーがGoogleアカウントを選択・承認
4. アプリケーションへリダイレクト（認証コード付き）
5. バックエンドで認証コードをトークンに交換
6. ユーザー情報を取得し、DBに保存（初回の場合）
7. 出張管理ページへリダイレクト

#### データ構造（概念）
```yaml
User:
  識別子: Google User ID（一意）
  基本情報:
    - email（必須）
    - name（必須）
    - picture（任意）
  認証情報:
    - google_access_token（必須）
    - google_refresh_token（必須）
  メタ情報:
    - 作成日時
    - 最終ログイン日時
```

---

### 3.2 P-002: 出張管理

#### 目的
出張情報の入力から報告書出力まで1画面で完結し、作業時間を劇的に短縮

#### 主要機能
- 出張一覧表示（検索・フィルター付き）
- 新規出張登録フォーム
- 出張詳細表示・編集
- 出張削除
- PDF報告書出力（選択した出張）
- CSV一括インポート
- 計算された手当額の表示

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 出張一覧を取得 | ユーザーID、フィルター条件（任意） | 出張データ一覧、計算済み手当額 |
| 作成 | 新規出張を登録 | 出張先、開始日、終了日、目的、実費（任意） | 出張レコード作成、手当額計算結果 |
| 更新 | 出張情報を編集 | 出張ID、更新内容 | 更新完了、再計算された手当額 |
| 削除 | 出張を削除 | 出張ID | 削除完了 |
| 出力 | PDF報告書を生成 | 出張ID | PDF形式の報告書ファイル |
| 一括作成 | CSVから一括登録 | CSVファイル（出張データ配列） | 登録完了件数、エラー情報 |

#### 処理フロー

**新規出張登録**:
1. ユーザーが「新規出張登録」ボタンをクリック
2. 登録フォームが表示される
3. 出張先、開始日、終了日、目的、実費（任意）を入力
4. 「登録」ボタンをクリック
5. バックエンドで旅費規定に基づいて手当額を自動計算
6. DBに保存
7. Google Sheets APIで個人別スプレッドシートに追記
8. 一覧画面に反映

**PDF出力**:
1. ユーザーが出張一覧から対象の出張を選択
2. 「PDF出力」ボタンをクリック
3. フロントエンドでjsPDF + html2canvasを使用してPDF生成
4. ブラウザでダウンロード

**CSV一括インポート**:
1. ユーザーが「CSV一括インポート」ボタンをクリック
2. ファイル選択ダイアログが表示
3. CSVファイルを選択
4. react-papaparseでCSVを解析
5. データをバリデーション
6. バックエンドに一括送信
7. バックエンドで各出張の手当を計算
8. DBに一括保存
9. Google Sheets APIで一括追記
10. 結果（成功件数、エラー情報）を表示

#### データ構造（概念）
```yaml
BusinessTrip:
  識別子: trip_id（自動生成UUID）
  基本情報:
    - destination（出張先）（必須）
    - start_date（開始日）（必須）
    - end_date（終了日）（必須）
    - purpose（目的）（必須）
    - notes（備考）（任意）
  実費情報:
    - accommodation_cost（宿泊費実費）（任意）
    - transportation_cost（交通費実費）（任意）
    - other_cost（その他実費）（任意）
  計算結果:
    - daily_allowance（日当）（自動計算）
    - accommodation_allowance（宿泊手当）（自動計算）
    - transportation_allowance（交通費手当）（自動計算）
    - total_allowance（合計手当額）（自動計算）
  メタ情報:
    - user_id（所有者）（必須）
    - 作成日時
    - 更新日時
  関連:
    - User（1対多）
```

---

### 3.3 P-003: 旅費規定設定

#### 目的
会社独自の旅費規定を柔軟に設定し、どんな会社でも正確な手当計算を実現

#### 主要機能
- 宿泊日当設定（宿泊を伴う出張の日当）
- 日帰り日当設定（日帰り出張の日当）
- 宿泊費設定（定額/実費上限）
- 交通費設定（定額/実費）
- 規定のプレビュー・テスト計算

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 現在の旅費規定を取得 | ユーザーID | 旅費規定データ |
| 作成/更新 | 旅費規定を保存 | 規定内容（JSON形式） | 保存完了 |
| テスト計算 | サンプルデータで計算テスト | テスト用出張データ | 計算結果のプレビュー |

#### 処理フロー
1. ユーザーが旅費規定設定ページを開く
2. 現在の設定を取得・表示
3. 各項目（宿泊日当、日帰り日当、宿泊費、交通費）を編集
4. 「テスト計算」でサンプルデータを入力し計算結果を確認
5. 「保存」ボタンでDBに保存
6. 以降の出張登録時にこの規定が適用される

**日当の判定ロジック**:
- 開始日 = 終了日の場合 → 日帰り出張として「日帰り日当」を適用
- 開始日 < 終了日の場合 → 宿泊出張として「宿泊日当」×日数を適用

#### データ構造（概念）
```yaml
TravelExpensePolicy:
  識別子: policy_id（自動生成UUID）
  日当設定:
    - daily_allowance_with_accommodation（宿泊日当）（必須）
    - daily_allowance_day_trip（日帰り日当）（必須）
  宿泊費設定:
    - accommodation_type（定額 or 実費上限）（必須）
    - accommodation_amount（金額）（必須）
  交通費設定:
    - transportation_type（定額 or 実費）（必須）
    - transportation_amount（金額）（任意）
  メタ情報:
    - user_id（所有者）（必須）
    - 作成日時
    - 更新日時
  関連:
    - User（1対1）
```

---

### 3.4 P-004: システム設定

#### 目的
Google Sheets連携とPDF出力フォーマットを設定し、スプレッドシート自動連携とカスタマイズされた報告書出力を実現

#### 主要機能
- Google Sheets連携設定（OAuth認証、スプレッドシート作成）
- 連携状態の確認
- PDF出力フォーマット設定（会社名）
- データエクスポート（全データCSV出力）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 認証 | Google Sheets連携の認証 | なし（Googleが処理） | 認証トークン |
| 作成 | 個人用スプレッドシートを作成 | スプレッドシート名 | スプレッドシートID、URL |
| 取得 | 連携状態を確認 | ユーザーID | 連携状態、スプレッドシート情報 |
| 取得 | PDF設定を取得 | ユーザーID | PDF設定データ |
| 更新 | PDF設定を保存 | 会社名 | 保存完了 |
| 出力 | 全データCSV出力 | ユーザーID | CSV形式の全出張データ |

#### 処理フロー

**Google Sheets連携**:
1. ユーザーが「Google Sheets連携」ボタンをクリック
2. Google OAuth認証画面へリダイレクト（Sheets API権限を要求）
3. ユーザーが承認
4. 認証トークンを取得・保存
5. バックエンドでGoogle Sheets APIを使用して新規スプレッドシートを作成
6. スプレッドシートIDとURLを保存
7. 連携完了メッセージと作成されたスプレッドシートのリンクを表示

**PDF設定**:
1. ユーザーがPDF設定セクションを開く
2. 会社名を入力
3. 保存

#### データ構造（概念）
```yaml
SystemSettings:
  識別子: settings_id（自動生成UUID）
  Google Sheets連携:
    - sheets_access_token（アクセストークン）（任意）
    - sheets_refresh_token（リフレッシュトークン）（任意）
    - spreadsheet_id（スプレッドシートID）（任意）
    - spreadsheet_url（スプレッドシートURL）（任意）
    - is_sheets_connected（連携状態）（必須）
  PDF設定:
    - company_name（会社名）（任意）
  メタ情報:
    - user_id（所有者）（必須）
    - 作成日時
    - 更新日時
  関連:
    - User（1対1）
```

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
User:
  概要: システム利用者（個人）
  主要属性:
    - 識別情報: Google User ID、email、name
    - 認証情報: access_token、refresh_token
  関連:
    - BusinessTrip（1対多）
    - TravelExpensePolicy（1対1）
    - SystemSettings（1対1）

BusinessTrip:
  概要: 出張記録
  主要属性:
    - 出張情報: destination、start_date、end_date、purpose
    - 実費情報: accommodation_cost、transportation_cost、other_cost
    - 計算結果: daily_allowance、total_allowance
  関連:
    - User（多対1）

TravelExpensePolicy:
  概要: 旅費規定設定
  主要属性:
    - 日当設定: daily_allowance_with_accommodation（宿泊日当）、daily_allowance_day_trip（日帰り日当）
    - 宿泊費設定: accommodation_type、accommodation_amount
    - 交通費設定: transportation_type、transportation_amount
  関連:
    - User（1対1）

SystemSettings:
  概要: システム設定（Google Sheets連携、PDF設定）
  主要属性:
    - Google Sheets: access_token、spreadsheet_id、spreadsheet_url
    - PDF設定: company_name
  関連:
    - User（1対1）
```

### 4.2 エンティティ関係図
```
User ─┬─ BusinessTrip     （1対多）
      ├─ TravelExpensePolicy  （1対1）
      └─ SystemSettings   （1対1）
```

### 4.3 バリデーションルール
```yaml
destination（出張先）:
  - ルール: 1文字以上100文字以内
  - 理由: 必須項目、かつ適切な長さ制限

start_date（開始日）:
  - ルール: 日付形式（YYYY-MM-DD）
  - 理由: 日付として正しい形式

end_date（終了日）:
  - ルール: start_date以降の日付
  - 理由: 論理的に正しい期間

purpose（目的）:
  - ルール: 1文字以上500文字以内
  - 理由: 必須項目、報告書に必要

email（メールアドレス）:
  - ルール: 有効なメール形式
  - 理由: Google認証で取得、通知送信に使用

daily_allowance_with_accommodation（宿泊日当）:
  - ルール: 0以上の数値
  - 理由: 金額は負数不可

daily_allowance_day_trip（日帰り日当）:
  - ルール: 0以上の数値
  - 理由: 金額は負数不可

accommodation_type（宿泊費タイプ）:
  - ルール: "定額" または "実費上限"
  - 理由: 計算ロジックで分岐するため明確な値が必要
```

---

## 5. 制約事項

### 外部API制限
- **Google Sheets API**: 1プロジェクトあたり1日500リクエストまで無料
  - 個人利用では十分な範囲
  - 超過する場合はエラーメッセージを表示
- **Google OAuth 2.0**: アクセストークンの有効期限は1時間
  - リフレッシュトークンで自動更新

### 技術的制約
- **PDF生成**: ブラウザ上で実行のため、大量の出張データを一度に出力すると時間がかかる可能性
  - 1回のPDF出力は1出張のみを推奨
- **CSVインポート**: ブラウザのメモリ制限により、一度に数千件以上のインポートは避ける
  - 推奨: 1回あたり500件以内
- **ファイルサイズ**: CSVファイルは10MB以内を推奨

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: 出張登録とGoogle Sheets同期
**トリガー**: ユーザーが出張登録フォームで「登録」ボタンをクリック
**フロントエンドAPI**: POST /api/business-trips
**バックエンド内部処理**:
1. 出張データのバリデーション
2. 旅費規定を取得
3. 旅費規定に基づいて手当額を自動計算
   - 開始日 = 終了日の場合 → 日帰り出張として「日帰り日当」を適用
   - 開始日 < 終了日の場合 → 宿泊出張として「宿泊日当」×日数を適用
   - 宿泊費を計算（定額 or 実費上限）
   - 交通費を計算（定額 or 実費）
   - 合計手当額を算出
4. PostgreSQLに出張データを保存
5. ユーザーのGoogle Sheets連携設定を確認
6. 連携されている場合、Google Sheets APIでスプレッドシートに行を追加
7. 保存・同期完了を返す
**結果**: 出張データ、計算済み手当額
**外部サービス依存**: Google Sheets API

### 複合処理-002: CSV一括インポートと手当計算
**トリガー**: ユーザーがCSVファイルをアップロード
**フロントエンドAPI**: POST /api/business-trips/bulk-import
**バックエンド内部処理**:
1. CSVデータの受信（配列形式）
2. 各レコードのバリデーション
3. 旅費規定を取得
4. 各出張の手当額を計算
5. トランザクション内でPostgreSQLに一括挿入
6. Google Sheets連携が有効な場合、一括で追記
7. 成功件数、エラー情報を返す
**結果**: 登録完了件数、エラー詳細（あれば）
**外部サービス依存**: Google Sheets API

### 複合処理-003: Google Sheets連携初期化
**トリガー**: ユーザーが「Google Sheets連携」ボタンをクリック
**フロントエンドAPI**: POST /api/settings/connect-sheets
**バックエンド内部処理**:
1. Google OAuth 2.0でアクセストークン取得
2. Google Sheets APIで新規スプレッドシートを作成
3. スプレッドシートにヘッダー行（出張先、開始日、終了日、目的、手当額等）を挿入
4. スプレッドシートIDとURLをSystemSettingsに保存
5. 既存の出張データがあれば、一括でスプレッドシートに追記
6. スプレッドシート情報を返す
**結果**: スプレッドシートURL、連携完了通知
**外部サービス依存**: Google OAuth 2.0、Google Sheets API

---

## 7. 技術スタック

### フロントエンド
```yaml
フレームワーク: React 18
言語: TypeScript 5
UIライブラリ: MUI v6
状態管理: Zustand
ルーティング: React Router v6
データフェッチ: React Query
ビルドツール: Vite 5
特殊ライブラリ:
  - react-papaparse: CSVインポート・エクスポート
  - jsPDF: PDF生成（日本語対応）
  - html2canvas: HTML→Canvas変換（PDF生成用）
  - @react-oauth/google: Google OAuth認証
```

### バックエンド
```yaml
言語: Python 3.11+
フレームワーク: FastAPI
ORM: SQLAlchemy
バリデーション: Pydantic
Google連携:
  - google-auth-oauthlib: Google OAuth認証
  - google-api-python-client: Google Sheets API連携
```

### データベース
```yaml
メインDB: PostgreSQL（Neon）
  - サーバーレスで管理不要
  - 無料枠で十分（個人利用）
```

### インフラ
```yaml
フロントエンド: Vercel
  - React/Viteに最適化
  - 自動デプロイ
  - 無料枠で十分

バックエンド: Google Cloud Run
  - サーバーレス
  - 自動スケーリング
  - Google APIsとの親和性が高い

データベース: Neon（PostgreSQL）
  - 無料枠で十分
  - サーバーレス
```

---

## 8. 必要な外部サービス・アカウント

### 必須サービス
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Google Cloud Platform | APIの有効化・管理 | https://console.cloud.google.com/ | 無料、GCPプロジェクト作成が必要 |
| Google Sheets API | 個人別スプレッドシートへのデータ自動連携 | GCP Console内で有効化 | 無料（1日500リクエストまで） |
| Google OAuth 2.0 | ユーザー認証 | GCP Console内で設定 | 無料 |
| Neon (PostgreSQL) | データベース | https://neon.tech/ | 無料枠あり（512MB RAM、3GB ストレージ） |

### オプションサービス
なし

---

## 9. 今後の拡張予定

**現時点では拡張予定なし。必要最小限の機能のみを実装します。**

将来的に以下のような拡張が考えられますが、今回は実装しません:
- 複数ユーザー対応（企業版）
- 承認ワークフロー
- 領収書画像のアップロード・管理
- 経費精算システムとの連携
- モバイルアプリ版

---

**作成日**: 2025-11-02
**バージョン**: 1.0
